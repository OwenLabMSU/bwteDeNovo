---
title: "Shed Level Late Stage Infection - Bursa - Gene"
author: "Amanda Dolinski & Jared J. Homola"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

\pagenumbering{gobble}

This is an analysis of differential expression at the gene level between between low, moderate, and high LPAIV shedding blue-winged teals based on cloacal swab virus titers averaged across 1-5 days post-infection (DPI) for bursa samples collected on 5 DPI.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.pos = 'H')
```

```{r message=FALSE, warning=FALSE}
## Load packages and data
library(limma)
library(edgeR)
library(Glimma)
library(gplots)
library(ggrepel)
library(RColorBrewer)
library(kableExtra)
library(gridExtra)
library(topGO)
library(tidyverse)

## Load data
annot <- read.delim("G:/Shared drives/RNA Seq Supershedder Project/BWTE DE manuscript/extData/Trinotate.csv", header = TRUE, sep = "\t")
cnt <- read.table("G:/Shared drives/RNA Seq Supershedder Project/BWTE DE manuscript/extData/rsem.gene.counts.matrix", header = TRUE)
covars <- read.csv("G:/Shared drives/RNA Seq Supershedder Project/BWTE DE manuscript/extData/BWTE54_SSgroup_Raw_Pool.csv", header = TRUE)
```

```{r, warning = FALSE, message = FALSE}
cnt <- cnt %>%
  select(
    -alignEstimateAbundance_BWTE_Ileum_36_S50,
    -alignEstimateAbundance_BWTE_Bursa_36_S31,-alignEstimateAbundance_BWTE_Ileum_19_S35,
    -alignEstimateAbundance_BWTE_Bursa_19_S14) %>%
  rownames_to_column("gene") %>%
  separate(gene, into = c(NA, "pt1", "pt2", "gene")) %>%
  unite(gene, pt1, pt2, gene) %>%
  column_to_rownames("gene") %>% 
  select(contains("Bursa"))

covars <- covars %>%
  filter(!bird %in% c("36", "19")) %>%
  arrange(bird) %>%
  mutate(group = str_remove(group, "-"))

annot <- annot %>%
  separate(transcript_id, into = c(NA, "pt1", "pt2", "gene", "isoform")) %>%
  unite(transcript_id, pt1, pt2, gene, isoform) %>% 
  separate(gene_id, into = c(NA, "pt1", "pt2", "gene")) %>%
  unite(gene_id, pt1, pt2, gene)
```

```{r, warning = FALSE, message = FALSE}
bird <- as.factor(covars$bird)
sex <- as.factor(covars$sex)
age <- as.numeric(covars$age)
weight <- covars$wt_55
group <- recode(covars$group, C1 = "Ctl", C14 = "Ctl") %>% 
  as.factor()
pool <- as.factor(covars$Pool.Bursa)
ssgroup.virus.avg <- as.factor(covars$SSgroup.virus.avg)

covars.tib <- data.frame(bird,
                    sex,
                    age,
                    weight,
                    group,
                    pool,
                    ssgroup.virus.avg) %>% 
  as_tibble()
```
 
```{r, warning = FALSE, message = FALSE, results = 'hide'}
#Convert to DGEList object
dge <- DGEList(counts=cnt)
dge$genes <- annot[match(rownames(dge$counts), annot$gene_id),]

#CPM and log-CPM
cpm <- cpm(dge)
lcpm <- cpm(dge, log = TRUE)

#### Retain only genes expressed at >0.5 CPM in at least 25% of individuals
table(rowSums(dge$counts==0) == length(cnt[1,]))
keep.exprs <- rowSums(cpm>0.5) >= length(cnt[1,])/4
sum(keep.exprs)

dge <- dge[keep.exprs,, keep.lib.sizes=FALSE]
table(rowSums(dge$counts==0) == length(cnt[1,]))
dim(dge)

#TMM normalization
dge <- calcNormFactors(dge, method = "TMM")

dge$samples$group <- covars.tib$group

### Divide out I5
dge.I5 <- dge[,grep('I5', dge$samples$group)]
covars.I5 <- covars.tib %>% filter(group == "I5")
```

# Differential expression analysis
```{r, warning = FALSE, message = FALSE}
## Establish design matrix: I5
design.I5 = model.matrix(~ 0 +
                        factor(covars.I5$ssgroup.virus.avg) +
                        covars.I5$age +
                        covars.I5$sex + 
                        covars.I5$weight + 
                        covars.I5$pool)

colnames(design.I5) <- c("HIGH", "LOW", "MODERATE",
                         "age", "sexM", "weight", "pool2", "pool3")


contr.matrix.I5 = makeContrasts(
  LvM = LOW - MODERATE,
  MvH = MODERATE - HIGH,
  LvH = LOW - HIGH,
  levels = colnames(design.I5))

## Mean-variance trend plots
v.I5 <- voomWithQualityWeights(dge.I5, design.I5, plot = FALSE)

#Fitting models
vfit.I5 <- lmFit(v.I5, design.I5) 
vfit.I5 <- contrasts.fit(vfit.I5, contrasts = contr.matrix.I5)
tfit.I5 <- treat(vfit.I5, lfc = 1.0)

## Identify DE genes
dt.I5 <- decideTests(tfit.I5, p.value = 0.1, adjust.method = "fdr")
dt.tib.I5 <- as_tibble(dt.I5, rownames = NA) %>% 
  rownames_to_column("gene") %>% 
  mutate_at(vars(starts_with("L")), as.numeric) %>% 
  mutate_at(vars(starts_with("M")), as.numeric) %>% 
  rename(LvM.I5 = LvM,
         MvH.I5 = MvH,
         LvH.I5 = LvH)

dt.tib <- dt.tib.I5 %>% 
  mutate_at(vars(starts_with("L")), as.numeric) %>% 
  mutate_at(vars(starts_with("M")), as.numeric) %>% 
  filter_at(vars(LvM.I5:LvH.I5), any_vars(. != 0))

allResults <- as.data.frame(summary(dt.I5)) %>% 
  filter(Var1 != "NotSig") %>% 
  rename("Direction" = Var1,
         "Comparison" = Var2,
         "N" = Freq)

kbl(allResults, booktabs = T, caption = "Count of DE genes. For a gene to be considered differentially expressed, we require a p-value of 0.1 with a false discovery rate correction and a log fold change difference of 1.0.") %>% 
  kable_styling(position ="center", latex_options = c("hold_position"))
```

\newpage 

### Volcano plot  
Volcano plot reporting -log10(p-values) as a function of log2(fold change) between the samples (logFC, x axis). Genes that are identified as significantly differentially expressed following a false discovery rate correction (q = 0.10) are shown in red 
```{r, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 7, fig.align = "center"}
tmp1 <- topTreat(tfit.I5, coef = 1, n = Inf)
results1 <- mutate(tmp1, sig=ifelse(tmp1$adj.P.Val<0.1, "Sig", "Not Sig"))
p1 <- ggplot(results1, aes(logFC, -log10(P.Value))) +
  geom_point(aes(col = sig)) +
  scale_color_manual(values=c("black", "red")) +
  ggtitle("Low vs. Moderate shedding") +
  ylab("-Log10(Adjusted p-value)") +
  xlab("Log(Fold count)") +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(size = 9))


tmp2 <- topTreat(tfit.I5, coef = 2, n = Inf)
results2 <- mutate(tmp2, sig=ifelse(tmp2$adj.P.Val<0.1, "Sig", "Not Sig"))
p2 <- ggplot(results2, aes(logFC, -log10(P.Value))) +
  geom_point(aes(col = sig)) +
  scale_color_manual(values=c("black", "red")) +
  ggtitle("Moderate vs. High shedding") +
  ylab("-Log10(Adjusted p-value)") +
  xlab("Log(Fold count)") +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(size = 9))

tmp3 <- topTreat(tfit.I5, coef = 3, n = Inf)
results3 <- mutate(tmp3, sig=ifelse(tmp3$adj.P.Val<0.1, "Sig", "Not Sig"))
p3 <- ggplot(results3, aes(logFC, -log10(P.Value))) +
  geom_point(aes(col = sig)) +
  scale_color_manual(values=c("black", "red")) +
  ggtitle("Low vs. High shedding") +
  ylab("-Log10(Adjusted p-value)") +
  xlab("Log(Fold count)") +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(size = 9))

grid.arrange(p1, p2, p3, nrow = 1)
```

```{r message=FALSE, warning=FALSE}
tmp1a <- tmp1 %>% select(gene_id, adj.P.Val, logFC, sprot_Top_BLASTX_hit, Kegg) %>% separate(sprot_Top_BLASTX_hit, into = c("SwissProt_GeneName", NA, NA, NA, NA, "sprot2", NA), "\\^") %>%   separate(sprot2, sep = "=", into = c(NA, "SwissProt_GeneFunction")) %>%  separate(Kegg, into = c("KEGG_ID", "KO_ID"), sep = "\\`") %>%  mutate(comp = "LvM")
tmp2a <- tmp2 %>% select(gene_id, adj.P.Val, logFC, sprot_Top_BLASTX_hit, Kegg) %>% separate(sprot_Top_BLASTX_hit, into = c("SwissProt_GeneName", NA, NA, NA, NA, "sprot2", NA), "\\^") %>%   separate(sprot2, sep = "=", into = c(NA, "SwissProt_GeneFunction")) %>%  separate(Kegg, into = c("KEGG_ID", "KO_ID"), sep = "\\`") %>% mutate(comp = "MvH")
tmp3a <- tmp3 %>% select(gene_id, adj.P.Val, logFC, sprot_Top_BLASTX_hit, Kegg) %>% separate(sprot_Top_BLASTX_hit, into = c("SwissProt_GeneName", NA, NA, NA, NA, "sprot2", NA), "\\^") %>%   separate(sprot2, sep = "=", into = c(NA, "SwissProt_GeneFunction")) %>%  separate(Kegg, into = c("KEGG_ID", "KO_ID"), sep = "\\`") %>% mutate(comp = "LvH")

bind_rows(tmp1a, tmp2a, tmp3a) %>% 
  select(-SwissProt_GeneFunction, -KEGG_ID, -KO_ID) %>% 
  filter(gene_id %in% dt.tib$gene) %>% 
  mutate(logFoldCount = ifelse(adj.P.Val < 0.10, round(logFC, 2), "ns")) %>% 
  select(-adj.P.Val, -logFC) %>% 
  pivot_wider(names_from = comp, values_from = logFoldCount) %>% 
  kbl(booktabs = T, 
      longtable =T,
      caption ="Annotations for differentially expressed genes. ns denotes non-significant genes for each comparison and numerical values are the log(fold change) difference") %>%
  kable_styling(latex_options = c("repeat_header"))
```
